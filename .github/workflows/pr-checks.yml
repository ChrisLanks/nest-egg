name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Run quick linting first to fail fast
  quick-lint:
    name: Quick Lint Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Black and isort
        run: pip install black==24.1.1 isort==5.13.2

      - name: Check formatting
        working-directory: ./backend
        run: |
          black --check app tests || (echo "❌ Code is not formatted. Run: make format" && exit 1)
          isort --check-only app tests || (echo "❌ Imports are not sorted. Run: make format" && exit 1)

  # Comment on PR with coverage report
  coverage-comment:
    name: Coverage Comment
    runs-on: ubuntu-latest
    needs: quick-lint
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with coverage
        working-directory: ./backend
        env:
          DATABASE_URL: sqlite+aiosqlite:///:memory:
          SECRET_KEY: test-secret-key
          DEBUG: true
        run: |
          pytest --cov=app --cov-report=term-missing > coverage.txt
          echo "Coverage report:" >> $GITHUB_STEP_SUMMARY
          cat coverage.txt >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with coverage
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 70

  # Check for breaking changes
  check-migrations:
    name: Check Database Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Check for migration changes
        run: |
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -q "alembic/versions/"; then
            echo "⚠️ Database migration detected. Please ensure:"
            echo "1. Migration is reversible (has downgrade)"
            echo "2. Migration is tested"
            echo "3. Production data migration plan exists"
            echo "4. Deployment order documented"
          fi

  # Validate API changes don't break contracts
  api-contract-check:
    name: API Contract Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for API changes
        run: |
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -q "app/api/"; then
            echo "⚠️ API changes detected. Please ensure:"
            echo "1. Backward compatibility maintained"
            echo "2. API documentation updated"
            echo "3. Breaking changes documented in PR"
            echo "4. Frontend updated if needed"
          fi
